<!DOCTYPE html>
<html>
<head>
  <title>Automation Dashboard</title>

  <link rel="icon" type="image/png" href="assets/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f8; }
    h1 { text-align: center; margin-bottom: 20px; }

    #runs { display: flex; flex-direction: column; gap: 8px; max-width: 1000px; margin: 0 auto 20px; }

    .run-item { 
      padding: 10px 15px; 
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      transition: background 0.2s, border 0.2s;
    }
    .run-item:hover { background: #e1f5fe; }

    /* Highlighted selected run */
    .run-item.selected {
      border: 2px solid #2196f3;
      background: #e3f2fd;
    }

    .status-badge { 
      padding: 3px 8px; 
      border-radius: 12px; 
      color: #fff; 
      font-weight: bold; 
      margin-left: 5px; 
      font-size: 0.85em; 
      min-width: 50px; 
      text-align: center; 
      background-color: #607d8b; /* default fallback */
    }

    .passed { background-color: #4caf50; }
    .failed { background-color: #f44336; }
    .skipped { background-color: #9e9e9e; }
    .flaky { background-color: #ff9800; }
    .unknown { background-color: #607d8b; }
    .timedout { background-color: #9c27b0; color: #fff; } /* purple bg with white text */

    #totals { text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 10px; }

    .charts-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 1000px;
      margin: 0 auto 30px;
    }

    .chart-box {
      flex: 1;
      min-width: 400px;
      max-width: 480px;
      height: 400px;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas { width: 100%; height: 100%; }

    a { margin-left: 10px; display: inline-block; }
  </style>
</head>
<body>
  <h1>Automation Test Analytics Dashboard</h1>

  <div id="runs"></div>

  <div id="totals">Total: 0 | Passed: 0 | Failed: 0</div>

  <div class="charts-container">
    <div class="chart-box">
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <script>
    let barChart = null;
    let pieChart = null;

    async function loadRuns() {
      const res = await fetch('/api/runs');
      const runs = await res.json();
      const runsDiv = document.getElementById('runs');

      runs.forEach((run, index) => {
        const runDiv = document.createElement('div');
        runDiv.className = 'run-item';

        const badges = Object.entries(run.stats).map(([status, count]) => 
          `<span class="status-badge ${status}">${status.toUpperCase()}: ${count}</span>`
        ).join(' ');

        runDiv.innerHTML = `<div><b>${run.timestamp}</b> ${badges}</div>
                            <a href="${run.htmlReport}" target="_blank">View HTML Report</a>`;

        runDiv.addEventListener('click', () => {
          // Remove highlight from all runs
          document.querySelectorAll('.run-item').forEach(el => el.classList.remove('selected'));
          // Highlight the clicked run
          runDiv.classList.add('selected');
          // Update charts
          updateCharts(run);
        });

        runsDiv.appendChild(runDiv);

        // Auto-highlight and load charts for the first run
        if (index === 0) {
          runDiv.classList.add('selected');
          updateCharts(run);
        }
      });
    }

    function updateCharts(run) {
      const labels = Object.keys(run.stats);
      const data = Object.values(run.stats);
      const colors = labels.map(status => {
        switch(status) {
          case 'passed': return '#4caf50';
          case 'failed': return '#f44336';
          case 'skipped': return '#9e9e9e';
          case 'flaky': return '#ff9800';
          case 'timedout': return '#9c27b0';
          default: return '#607d8b';
        }
      });

      // Update totals
      const total = data.reduce((a,b) => a+b, 0);
      const passed = run.stats.passed || 0;
      const failed = run.stats.failed || 0;
      document.getElementById('totals').textContent = `Total: ${total} | Passed: ${passed} | Failed: ${failed}`;

      // Bar chart
      const barCtx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { 
          labels, 
          datasets: [{ label: `Test Status - ${run.timestamp}`, data, backgroundColor: colors }] 
        },
        options: {
          responsive: true,
          plugins: { 
            legend: { display: false }, 
            tooltip: { 
              enabled: true, 
              callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}` } 
            },
            title: { 
              display: true, 
              text: `Total Tests: ${total}`, 
              font: { size: 12 },
              padding: { top: 10, bottom: 20 }
            }
          },
          scales: { 
            y: { beginAtZero: true, title: { display: true, text: 'Test Count' } },
            x: { title: { display: true, text: 'Status' } }
          }
        }
      });

      // Pie chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels, datasets: [{ label: `Test Status - ${run.timestamp}`, data, backgroundColor: colors }] },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            tooltip: { 
              enabled: true,
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            },
            title: { display: true, text: `Total Tests: ${total}` }
          }
        }
      });
    }

    loadRuns();
  </script>
</body>
</html>
